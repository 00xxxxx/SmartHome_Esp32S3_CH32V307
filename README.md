# 基于ESP32-S3＋CH32V307的人脸识别智能家居系统

## 项目描述

本项目是一套采用双MCU架构的低功耗、智能化家居系统。系统以 ESP32-S3 为主控制器，负责算力密集型任务，如人脸识别和语音处理；以 CH32V307 (RISC-V) 为从控制器，专注于高实时性的外设驱动与环境数据采集，并作为**Zigbee网关**，汇集来自无线传感器节点的报警信息。

该系统不仅支持通过人脸识别控制门锁、管理用户权限及处理异常开锁情况，还集成了语音指令控制、定时环境数据上报、火灾与入侵联合报警、以及基于环境光感的自动灯光调控。**通过新增的MQTT客户端功能，系统现已支持通过手机或PC进行远程指令控制，实现了便捷的远程家居管理。** 整体架构设计旨在实现优秀的稳定性、实时性和未来功能扩展性。

---

## 系统核心功能

- **人脸识别门禁**
    - 使用 `OV2640` 摄像头实时采集图像。
    - 利用乐鑫 `ESP-WHO` AI框架在 `ESP32-S3` 上实现人脸录入、检测与识别。
    - 根据识别结果向下级控制器发送开锁或拒绝指令，并支持权限管理。

- **语音指令控制**
    - 集成 `INMP441` 高信噪比麦克风进行语音采集。
    - 通过 `ESP-SR` 语音识别框架处理语音信号，解析为控制指令。
    - 将解析后的指令通过串口下发，实现对家居设备的语音控制。

- **MQTT远程指令控制**
    - ESP32-S3启动后自动连接至预设的Wi-Fi网络。
    - 连接至**阿里云物联网平台**（或其他MQTT Broker），并订阅指定控制主题。
    - 接收来自云端的控制指令（如`LED2ON`），解析后通过串口下发给CH32V307从机，实现与语音控制等效的远程操作。

- **Zigbee无线传感网络**
    - CH32V307通过串口连接一个**CC2530协调器模块**，负责接收无线数据。
    - 远端**CC2530终端模块**连接红外和烟雾传感器，将报警信号通过Zigbee网络发送给协调器。
    - 实现了低功耗的远距离无线报警功能，扩展了系统的监控范围。

- **环境监测与上报**
    - `CH32V307` 连接 `DHT11` 传感器，周期性采集本地的温湿度数据。
    - 通过板载以太网模块，以 `UDP` 协议将环境数据定时上报至云端或本地服务器，便于远程监控。

- **自动化安防与调控**
    - 智能照明: 根据光敏电阻采集的环境光照强度自动开关灯光。
    - 复合报警: 当CH32V307接收到来自Zigbee节点的无线报警信号时，立即驱动蜂鸣器进行高优先级报警，并可通过按键手动消警。

- **多任务实时管理**
    - `ESP32-S3` 侧采用 `FreeRTOS` 操作系统，将摄像头采集、人脸识别、语音处理、MQTT通信等功能模块作为独立任务进行并行管理，确保系统在高负载下的稳定性和响应速度。

---

## 系统架构与技术栈

### 双MCU架构
- **主控制器 (Master): `ESP32-S3`**
    - 职责: 运行FreeRTOS、执行人脸/语音识别算法、**运行MQTT客户端以接收远程指令**、处理复杂逻辑、并通过串口向从机下发指令。
- **从控制器 (Slave): `CH32V307`**
    - 职责: 接收并校验主机指令、直接驱动所有外设（LED, 舵机, 蜂鸣器）、采集本地传感器数据、处理来自**Zigbee协调器**的无线报警数据、执行本地自动化逻辑、并通过以太网上报数据。
- **通信协议**:
    - 主从控制器之间采用 `UART` 串口通信。数据包包含帧头、命令字、数据负载和校验和，确保了指令传输的稳定与可靠。
    - 终端与协调器之间采用 `Zigbee` 无线通信协议。

### 技术栈清单
| 类别 | 技术点 |
| :--- | :--- |
| **硬件平台** | `ESP32-S3`, `CH32V307 (RISC-V)`, `CC2530`, `OV2640`, `INMP441`, `DHT11`,`各类传感器` |
| **核心框架** | `ESP-IDF`, `ESP-WHO`, `ESP-SR`, **`esp-mqtt`**, `FreeRTOS`, `Zigbee (Z-Stack)` |
| **通信接口** | `Ethernet` (UDP), `UART`, `I2C`, `SPI`, **`Wi-Fi`**, **`MQTT`**, `单总线`, `Zigbee` |
| **开发工具** | `MounRiver Studio`, `VS Code` with `ESP-IDF Plugin`, `IAR Embedded Workbench for 8051` |
| **开发语言** | `C/C++` |
| **操作系统** | `Ubuntu` (for ESP-IDF development) |

---

## 固件详情

### 1. CH32V307 从机固件

这部分是项目的外设控制和数据采集核心。

- **代码位置**: 所有源码及MounRiver工程文件均位于 `CH32_Firmware/` 目录下。
- **功能**:
    1.  初始化所有连接的传感器和执行器。
    2.  通过串口2与一个 **预烧录了透传固件的CC2530协调器模块** 通信，接收来自无线节点的报警。
    3.  监听来自 `ESP32-S3` 的串口指令，并执行相应动作 (如 `LED2ON`, `ReSuccess`)。
    4.  运行一个本地任务循环 (`Sensor_Task`)，处理自动光控和报警逻辑。
- **如何编译和下载**:
    1.  使用 MounRiver Studio 导入 `CH32_Firmware/CH32Controller/` 工程。
    2.  编译并使用 WCH-LinkE 下载。

### 2. CC2530 终端固件

这部分是为连接了红外和烟雾传感器的 **裸CC2530模块** 准备的固件。

- **代码位置**: 所有源码及IAR工程文件均位于 `CC2530_Firmware/` 目录下。
- **功能**:
    1.  初始化红外传感器和烟雾传感器。
    2.  作为一个Zigbee终端设备（End-Device）加入网络。
    3.  当传感器被触发时，通过Zigbee无线网络向协调器（连接在CH32V307上）发送报警指令。
- **如何编译和下载**:
    1.  确保已安装 IAR Embedded Workbench for 8051 和 TI Z-Stack-Home-1.2.2a。
    2.  使用 IAR 打开 `CC2530_Firmware/` 目录下的 `.eww` 工作区文件。（注意环境的修改！）
    3.  编译工程，并使用 CC-Debugger 将生成的固件下载到 CC2530 模块。

### 3. ESP32-S3 主机固件

这部分是项目的智能处理核心，负责运行AI算法和系统主逻辑。

- **代码位置**: 所有源码及ESP-IDF工程文件均位于项目根目录下（除 `CH32_Firmware/` 和 `CC2530_Firmware/` 目录）。
- **开发环境**: `ESP-IDF` (推荐 V5.0及以上)
- **核心任务**:
    - Camera Task: 使用 `esp_camera` 组件驱动 `OV2640` 进行图像采集。
    - Face-Rec Task: 将图像帧送入 `ESP-WHO` 框架进行人脸检测与识别。
    - Voice-Rec Task: 初始化 `INMP441` 麦克风，并使用 `ESP-SR` 进行语音识别。
    - **MQTT Task**: 使用 `wifi_connect` 组件连接网络，并启动 `mqtt_handler` 组件连接至MQTT Broker，监听控制主题，将接收到的指令转发至控制任务。
    - Control Task: 根据人脸/语音识别结果，或接收到的MQTT指令，组装命令并通过串口发送给 `CH32V307`。
- **如何配置**:
    - **Wi-Fi 配置**: 修改 `components/wifi_connect/wifi_connect.c` 文件中的 `WIFI_SSID` 和 `WIFI_PASS` 宏定义，填入您的Wi-Fi名称和密码。
    - **MQTT 配置**: 修改 `components/mqtt_handler/mqtt_handler.c` 文件中的宏定义，填入您申请的MQTT三元组信息 (`PRODUCT_KEY`, `DEVICE_NAME`, `DEVICE_SECRET`)。
- **如何编译和下载**:
    1.  参考[官方文档](https://docs.espressif.com/projects/esp-idf/en/latest/esp32s3/get-started/index.html)安装 ESP-IDF 并配置好开发环境。
    2.  在终端中进入 ESP32 的固件目录。
    3.  运行 `idf.py build` 进行编译。
    4.  运行 `idf.py -p (您的串口号) flash monitor` 来下载固件并查看日志。

---

## 未来展望

- **数据可视化与云端联动**: 当前已实现MQTT远程指令接收。未来可进一步将CH32V307采集的环境数据通过ESP32-S3上报至云端，实现数据看板和更复杂的云端自动化规则（如温湿度超限告警）。
- **更多节点**: 开发更多种类的Zigbee传感器（如门磁、水浸）和控制器（如智能插座）节点，构建更完整的全屋智能生态。

---

## CH32V307 硬件引脚分配

| 模块 | 引脚 | 功能描述 |
| :--- | :--- | :--- |
| **主控通信 (UART1)** | `PA9` (Tx), `PA10` (Rx) | 连接至ESP32-S3的串口1，用于主从通信 |
| **Zigbee通信 (UART2)** | `PA2` (Tx), `PA3` (Rx) | 连接CC2530协调器模块 |
| **以太网** | 板载RJ45接口 | 用于UDP数据上报 |
| **调试接口** | `PA13` (SWDIO), `PA14` (SWCLK) | 用于固件烧录与调试 |
| **温湿度传感器 (DHT11)** | `PC1` | 单总线协议数据引脚 |
| **光敏电阻** | `PA1` (ADC1_IN1) | 模拟输入，检测环境亮度 |
| **状态指示灯 (LED)** | `PC3` (LED1), `PC4` (LED2) | 推挽输出，低电平点亮 |
| **功能按键 (KEY)** | `PA0` (EXTI0) | 上拉输入，下降沿触发中断 |
| **蜂鸣器 (Buzzer)** | `PA5` | 推挽输出，高电平鸣叫 |
| **门锁舵机 (Servo)** | `PC5` (TIM3_CH2) | PWM输出，控制舵机角度 |

## CC2530 终端节点引脚分配

| 模块 | 引脚 | 功能描述 |
| :--- | :--- | :--- |
| **人体红外传感器 (SR602)** | `P0.0` | GPIO输入，高电平表示检测到人体 |
| **烟雾传感器 (MQ2)** | `P0.1` | 模拟输入，检测烟雾浓度 |

---

## ESP32-S3 硬件引脚分配

| 模块 | 引脚 | 功能描述 |
| :--- | :--- | :--- |
| **主从通信 (UART1)** | `GPIO16` (Tx), `GPIO15` (Rx) | 连接至CH32V307的串口1，用于主从通信 |
| **I2S麦克风 (INMP441)** | `GPIO36` (BCK), `GPIO37` (WS), `GPIO35` (DIN) | I2S总线，用于采集语音信号 |
| **摄像头 (OV2640)** | 详细引脚见下方列表 | SCCB接口及DVP数据总线 |
| **调试用LCD (ST7789)** | 详细引脚见下方列表 | SPI2总线，用于调试时显示图像或日志 |

### 详细引脚列表

- **ST7789 SPI LCD 模组 (320x240)**
  - *注意：LCD屏幕仅在调试时使用，不需要调试时可以拔出以节省IO口。*
  - **接线 (SPI2):**
    - `GPIO41`: MOSI
    - `GPIO40`: SCLK
    - `GPIO42`: CS
    - `GPIO47`: DC
    - `GPIO38`: RST
    - `GPIO3`: BLK (背光)

- **摄像头 (OV2640)**
  - **接线:**
    - `GPIO17`: RESET (复位)
    - `GPIO14`: SIOD (SCCB 数据)
    - `GPIO13`: SIOC (SCCB 时钟)
    - `GPIO1, 2, 4, 5, 6, 7, 8, 9`: D0-D7 (数据总线)
    - `GPIO11`: VSYNC (垂直同步)
    - `GPIO12`: HREF (水平参考)
    - `GPIO10`: PCLK (像素时钟)
